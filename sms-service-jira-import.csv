Summary,Description,Issue Type,Priority,Story Points,Sprint,Assignee,Parent
1.2.2 - MVP: Plivo SMS Provider Integration,"Create a minimal viable product that can send SMS messages via Plivo API.

Acceptance Criteria:
- Plivo NuGet package integrated
- ISmsProvider interface created in Core (abstract SendSmsAsync method)
- PlivoSmsProvider class created implementing ISmsProvider
- POST /api/test-sms endpoint for manual SMS testing
- Request body: { ""phoneNumber"": ""+1..."", ""message"": ""Test message"" }
- Response: { ""success"": true, ""messageId"": ""..."" } or error response
- Plivo API credentials from appsettings (not Key Vault yet)
- Structured logging for SMS send attempts
- Unit tests for PlivoSmsProvider (with mocked Plivo client) >80% coverage
- Can test locally without Azure infrastructure or database
- Runnable via docker-compose up + curl or Postman

Technical Notes:
- Crude implementation: hardcoded test sender number is acceptable
- No database, consent checks, or orchestrator logic yet - just plain send
- No authentication on test endpoint (MVP only, remove before prod)
- Error handling: map basic Plivo errors (invalid phone, auth failure)
- Phone number validation: basic E.164 format check
- Message validation: max 1600 characters for SMS

Dependencies: After 1.1 (can run parallel with 1.2.1)",Story,Highest,8,1138,,NLVN-28094
1.3.1 - Domain Models,"Create the core domain models (SmsMessage, VenuePhoneNumber, SmsSendHistory) aligned with nLiven entity patterns.

Acceptance Criteria:
- Implement SmsMessage domain object with status tracking
- Implement VenuePhoneNumber with FK to nLiven Venue.ID
- Implement SmsSendHistory with timestamp and provider tracking
- All models use int ID fields per nLiven pattern
- Enum status fields map to lookup tables
- Unit tests >80% coverage

Dependencies: After 1.1 (can run parallel with 1.2.x)",Story,Medium,3,1138,,NLVN-28094
1.3.2 - API Endpoint Design & Test Harness,"Design RESTful API contract for Sms/Send endpoint.

Acceptance Criteria:
- Create POST /api/sms/send endpoint specification
- Define request/response JSON schema
- Generate Swagger/OpenAPI documentation
- Create curl test harness with examples
- Document integration points with venue phone number lookup
- Unit tests >80% coverage

Dependencies: After 1.1 (can run parallel with 1.2.x and 1.3.1)",Story,Medium,3,1138,,NLVN-28094
1.4.1 - Database Schema & Migrations,"Create database schema with enum tables and business tables.

Acceptance Criteria:
- Implement 5 enum tables: ProviderNames, VenuePhoneNumberStatuses, SmsConsentStatuses, ConsentSources, SmsSendHistoryStatuses
- Implement VenuePhoneNumber table with int FK to nLiven Venue.ID
- Implement SmsSendHistory table with bigint ID for growth, message content, provider tracking
- Create EF Core DbContext with all entity mappings
- Generate migration scripts
- Unit tests for schema validation >80% coverage

Dependencies: After 1.3.1",Story,High,5,1138,,NLVN-28094
1.4.2 - Repository Layer Implementation,"Implement VenuePhoneNumberRepository and SmsSendHistoryRepository.

Acceptance Criteria:
- VenuePhoneNumberRepository: GetByVenueId, Create, Update
- SmsSendHistoryRepository: Create, GetById, GetByVenueId, UpdateStatus
- Unit tests with mocked EF Core DbContext >80% coverage
- Test both happy path and error cases
- Tests verify correct enum table FK lookups

Dependencies: After 1.4.1 (can run parallel with 1.4.3)",Story,High,5,1138,,NLVN-28094
1.4.3 - Service Bus Producer Setup,"Configure Azure Service Bus and implement SmsNotificationProducer.

Acceptance Criteria:
- Create Service Bus namespace and SmsNotificationSent topic
- Implement SmsNotificationProducer class
- Integrate with Key Vault for connection string
- Use ConfigCat feature flags for provider routing
- Unit and integration tests with mocked Service Bus >80% coverage
- Verify message serialization/deserialization

Dependencies: After 1.4.1 (can run parallel with 1.4.2)",Story,High,5,1138,,NLVN-28094
2.1 - GitHub Actions CI/CD Pipeline Setup,"Set up GitHub Actions CI/CD pipeline for build, test, and deployment to Azure.

Acceptance Criteria:
- GitHub Actions workflow created (.github/workflows/)
- Build job: dotnet build on every push
- Unit test job: dotnet test with coverage reports
- Docker build: image tagged with commit SHA
- Push to Azure Container Registry (ACR)
- Deploy to dev environment (manual approval gate for prod)
- Workflow runs in parallel for speed
- Coverage threshold enforced (fail if <80%)

Technical Notes:
- Use dotnet 10 SDK image
- Cache NuGet packages between runs
- Tag images: acr.azurecr.io/nliven-sms:latest and acr.azurecr.io/nliven-sms:${{ github.sha }}
- Dev environment deploys automatically on main branch
- Production requires manual approval

Dependencies: After 1.1 (can run parallel with 2.2 and 2.3)",Story,Highest,5,1138,,NLVN-28094
2.2 - Terraform Infrastructure - Base Resources,"Create Terraform configuration for core Azure resources.

Acceptance Criteria:
- Terraform project structure created (main.tf, variables.tf, outputs.tf)
- Resource group variables configured
- Azure Container Registry (ACR) resource
- Azure Container Apps environment
- Terraform state stored in Azure Storage
- Variables for environment (dev, staging, prod)
- Unit tests for Terraform >80% coverage

Technical Notes:
- Use terraform >= 1.0
- Store tfstate in Azure Storage with state locking
- Variables: resource group name, location, environment
- Outputs: ACR name, Container Apps environment name
- Can run in parallel with 2.1 and 2.3

Dependencies: After 1.1 (can run parallel with 2.1 and 2.3)",Story,Highest,8,1138,,NLVN-28094
2.3 - Terraform Infrastructure - SQL Database & Service Bus,"Create Terraform for database and messaging infrastructure.

Acceptance Criteria:
- Azure SQL Database resource (single database, standard tier)
- SQL Server login and firewall rules
- Database connection string in Key Vault
- Service Bus namespace and topic
- Service Bus connection string in Key Vault
- Terraform outputs for connection strings
- Unit tests for Terraform >80% coverage

Technical Notes:
- SQL: Standard tier for cost-efficiency, auto-backup enabled
- Service Bus: Standard tier with 2 topics (SmsNotificationRequested, IncomingSmsReceived)
- Key Vault stores all connection strings
- Firewall: Allow Azure services + developer IPs

Dependencies: Can run parallel with 2.2",Story,Highest,8,1138,,NLVN-28094
3.1 - Logging & Application Insights,"Integrate Serilog 8.x with structured logging and Application Insights.

Acceptance Criteria:
- Configure Serilog with Application Insights sink
- Log each SMS send attempt with timestamp, provider, phone number hash, status
- Structured logging includes correlation IDs for tracing
- Unit tests verify log output >80% coverage
- Application Insights dashboards created for SMS metrics",Story,Medium,3,1138,,NLVN-28094
3.2 - SMS Consent Service,"Implement business logic to check user SMS consent.

Acceptance Criteria:
- Call nLiven Consent microservice to verify user consent
- Block SMS send if user has opted out
- Integration via gRPC or REST API
- Mock Consent service in unit tests >80% coverage
- Handle Consent service unavailability gracefully
- Log consent check results for audit trail",Story,Medium,5,1138,,NLVN-28094
3.3 - Phone Number Formatting & Validation,"Validate and normalize international phone numbers.

Acceptance Criteria:
- Implement E.164 format validation (e.g., +1234567890)
- Use PhoneNumbers.NET library
- Support multiple country codes and extensions
- Reject invalid formats before SMS send
- Unit tests for country codes, extensions, edge cases >80% coverage
- Tests include 10+ country code examples",Story,Medium,3,1138,,NLVN-28094
3.4 - Rate Limiting & Quota Management,"Implement per-venue rate limiting for SMS sends.

Acceptance Criteria:
- Enforce 100 SMS/hour per venue (configurable via ConfigCat)
- Use Redis or in-memory cache for rate limit tracking
- Return 429 Too Many Requests when quota exceeded
- Unit and integration tests >80% coverage
- Tests verify quota tracking across concurrent requests
- Log rate limit violations for monitoring",Story,Medium,5,1138,,NLVN-28094
4.1 - Twilio Provider Adapter,"Implement ISmsSmsProvider interface for Twilio.

Acceptance Criteria:
- Implement Twilio SDK integration with API key authentication
- Load credentials from Key Vault
- Handle Twilio rate limits and throttling
- Implement timeout handling (default 5s)
- Unit tests with mocked HTTP client >80% coverage
- Tests verify credential loading, error cases, rate limit handling",Story,Medium,5,1138,,NLVN-28094
4.2 - Plivo Provider Adapter Production,"Refactor MVP provider into full production adapter.

Acceptance Criteria:
- Implement ISmsSmsProvider interface for Plivo
- Enhance error handling from MVP version
- Implement credential management via Key Vault
- Add timeout resilience (default 5s)
- Unit tests with mocked Plivo client >80% coverage
- Tests verify credential loading, all error scenarios",Story,Medium,5,1138,,NLVN-28094
5.1 - External Webhook Endpoint for Delivery Receipts,"Implement webhook endpoint to receive delivery status updates.

Acceptance Criteria:
- Implement POST /api/webhooks/sms-receipt endpoint
- Deserialize provider webhook payloads (Twilio, Plivo formats)
- Update SmsSendHistory status (delivered, failed, bounced)
- Validate webhook authenticity before processing
- Unit and integration tests >80% coverage
- Tests include samples from both providers",Story,Medium,5,1138,,NLVN-28094
5.2 - Webhook Signature Verification,"Implement cryptographic validation for SMS provider webhooks.

Acceptance Criteria:
- Implement Twilio X-Twilio-Signature header validation
- Implement Plivo signature validation
- Reject unsigned requests (return 401)
- Unit tests for both signature formats >80% coverage
- Tests verify valid and invalid signature handling
- Logging includes signature validation failures",Story,Medium,3,1138,,NLVN-28094
6.1 - Service Bus Consumer Setup,"Implement consumer for SmsNotificationRequested topic events.

Acceptance Criteria:
- Implement ServiceBusProcessor for SmsNotificationRequested topic
- Deserialize SmsMessage events from messages
- Call SmsService.SendAsync() for each event
- Implement message completion and error handling
- Unit and integration tests with mocked Service Bus >80% coverage
- Tests verify message consumption and processing",Story,High,5,1138,,NLVN-28094
6.2 - Event Schema & Producer Orchestration,"Define SmsNotificationRequested event contract and implement producer.

Acceptance Criteria:
- Define SmsNotificationRequested event schema with all required fields
- Update SmsService.SendAsync() to publish SmsNotificationSent event
- Implement event producer with proper serialization
- Unit and integration tests >80% coverage
- Tests verify event publishing, consumer integration
- Schema versioning documented",Story,High,5,1138,,NLVN-28094
6.3 - Dead-Letter Queue Handling,"Implement dead-letter queue consumer for failed events.

Acceptance Criteria:
- Implement DLQ consumer for SmsNotificationRequested topic
- Log detailed information about failed events
- Implement alerting mechanism (Application Insights alert or email)
- Unit and integration tests >80% coverage
- Tests verify DLQ message handling, alert generation
- DLQ retention policy configured (30 days)",Story,Medium,3,1138,,NLVN-28094
7.1 - Inbound SMS Endpoint (Advanced),"Implement inbound SMS endpoint (optional for v1).

Acceptance Criteria:
- Implement POST /api/sms/inbound endpoint (placeholder for v1)
- Validate sender ID against configured venue phone numbers
- Forward to IncomingSmsReceived topic
- Unit tests >80% coverage
- Tests verify sender validation, event publishing
- Include feature flag in ConfigCat for optional v1 deployment",Story,Low,3,1138,,NLVN-28094
7.2 - Outbound Status Webhooks,"Implement provider-agnostic webhook consumer.

Acceptance Criteria:
- Consume delivery status webhooks from all configured providers
- Transform provider-specific statuses to internal SmsSendHistoryStatus enum
- Update SmsSendHistory via repository
- Handle provider-specific payload formats
- Unit and integration tests >80% coverage
- Tests verify transformation logic for all providers",Story,Medium,5,1138,,NLVN-28094
8.1 - Provider Failover Logic,"Implement automatic failover between SMS providers.

Acceptance Criteria:
- Implement automatic failover from Twilio to Plivo on failure
- Use ConfigCat feature flags to control fallover behavior
- Log failover events with full context
- Unit and integration tests >80% coverage
- Tests verify failover triggering, success retry
- Failover behavior configurable per venue (future)",Story,Medium,5,1138,,NLVN-28094
8.2 - Multi-Provider Load Balancing,"Distribute SMS traffic across multiple providers.

Acceptance Criteria:
- Implement load balancing algorithm (round-robin or cost-based)
- Use ConfigCat rules to control % traffic routed to each provider
- Change provider distribution without code deployment
- Unit tests >80% coverage
- Tests verify traffic distribution, rule application
- Metrics track distribution accuracy",Story,Medium,5,1138,,NLVN-28094
8.3 - Provider Performance Metrics,"Track and display performance metrics for each provider.

Acceptance Criteria:
- Track SMS latency, success rate, cost per SMS for each provider
- Aggregate metrics and store in Application Insights
- Create dashboard comparing provider performance
- Unit tests >80% coverage
- Tests verify metric collection and aggregation
- Metrics queryable via Application Insights API",Story,Medium,3,1138,,NLVN-28094
9.1 - Load Testing & Performance Optimization,"Conduct load testing and optimize for 1000+ SMS/minute throughput.

Acceptance Criteria:
- Load test: 1000+ SMS/minute sustained throughput
- Optimize database queries (index analysis, query plan review)
- Implement caching for frequently accessed data
- Tune Service Bus settings (batch size, prefetch count)
- Create deployment runbook for scaling procedures
- Document scaling limits and recommendations
- Unit tests and performance benchmarks >80% coverage",Story,Medium,5,1138,,NLVN-28094
9.2 - Security Audit & Compliance,"Review code for security vulnerabilities and compliance.

Acceptance Criteria:
- OWASP Top 10 vulnerability review
- SQL injection prevention verification (parameterized queries)
- Secret management audit (Key Vault, no hardcoded secrets)
- Validate Key Vault integration, encrypted connections
- Create troubleshooting guide for common production issues
- Document security best practices for operators
- Security checklist verified and signed off",Story,High,5,1138,,NLVN-28094
9.3 - Production Deployment & Go-Live,"Deploy to Azure Container Apps and verify production readiness.

Acceptance Criteria:
- Deploy to Azure Container Apps with health checks
- Configure auto-scaling policies
- Verify Service Bus connections and credentials
- Verify SMS provider credentials and connectivity
- Run database migrations in production
- Create operational runbooks (start, stop, troubleshooting)
- Health check documentation and monitoring setup
- README with deployment and operational procedures
- Go-live checklist completed and signed off",Story,High,8,1138,,NLVN-28094
